{% extends "base.html" %}

{% block title %}POS - Restaurante POS{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .product-card:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .cart-item {
        border-bottom: 1px solid #dee2e6;
        padding: 10px 0;
    }
    .cart-summary {
        position: sticky;
        top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8">
            <h4 class="mb-3">Productos Disponibles</h4>
            <div class="row g-3">
                {% for product in products %}
                <div class="col-md-4 col-lg-3">
                    <div class="card product-card" onclick="addToCart({{ product.id }}, '{{ product.name }}', {{ product.price }})">
                        <div class="card-body text-center">
                            <i class="bi bi-cart-plus fs-1 text-primary"></i>
                            <h6 class="card-title mt-2">{{ product.name }}</h6>
                            <p class="card-text text-muted small">{{ product.description }}</p>
                            <p class="fw-bold text-success">${{ "%.2f"|format(product.price) }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if not products %}
            <div class="alert alert-info">
                No hay productos disponibles. <a href="{{ url_for('products') }}" class="alert-link">Agrega productos aquí</a>.
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-4">
            <div class="card cart-summary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cart"></i> Orden Actual</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="table_number" class="form-label">Mesa</label>
                        <input type="text" class="form-control" id="table_number" placeholder="Número de mesa">
                    </div>
                    
                    <div id="cart-items" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted text-center">No hay items en la orden</p>
                    </div>
                    
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Total:</strong>
                            <strong class="text-success" id="cart-total">$0.00</strong>
                        </div>
                        <button class="btn btn-success w-100" id="complete-order-btn" onclick="completeOrder()" disabled>
                            <i class="bi bi-check-circle"></i> Completar Orden
                        </button>
                        <button class="btn btn-secondary w-100 mt-2" onclick="clearCart()">
                            <i class="bi bi-trash"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cart = [];

function addToCart(id, name, price) {
    const existingItem = cart.find(item => item.id === id);
    if (existingItem) {
        existingItem.quantity++;
        existingItem.subtotal = existingItem.quantity * existingItem.price;
    } else {
        cart.push({
            id: id,
            name: name,
            price: price,
            quantity: 1,
            subtotal: price
        });
    }
    updateCart();
}

function removeFromCart(id) {
    cart = cart.filter(item => item.id !== id);
    updateCart();
}

function updateQuantity(id, change) {
    const item = cart.find(item => item.id === id);
    if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
            removeFromCart(id);
        } else {
            item.subtotal = item.quantity * item.price;
            updateCart();
        }
    }
}

function updateCart() {
    const cartItemsDiv = document.getElementById('cart-items');
    const cartTotalSpan = document.getElementById('cart-total');
    const completeBtn = document.getElementById('complete-order-btn');
    
    if (cart.length === 0) {
        cartItemsDiv.innerHTML = '<p class="text-muted text-center">No hay items en la orden</p>';
        cartTotalSpan.textContent = '$0.00';
        completeBtn.disabled = true;
        return;
    }
    
    let html = '';
    let total = 0;
    
    cart.forEach(item => {
        total += item.subtotal;
        html += `
            <div class="cart-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small class="text-muted">$${item.price.toFixed(2)} c/u</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <button class="btn btn-outline-secondary disabled">${item.quantity}</button>
                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <small>Subtotal:</small>
                    <strong>$${item.subtotal.toFixed(2)}</strong>
                </div>
            </div>
        `;
    });
    
    cartItemsDiv.innerHTML = html;
    cartTotalSpan.textContent = `$${total.toFixed(2)}`;
    completeBtn.disabled = false;
}

function clearCart() {
    cart = [];
    document.getElementById('table_number').value = '';
    updateCart();
}

async function completeOrder() {
    if (cart.length === 0) {
        alert('La orden está vacía');
        return;
    }
    
    const tableNumber = document.getElementById('table_number').value;
    const total = cart.reduce((sum, item) => sum + item.subtotal, 0);
    
    const orderData = {
        table_number: tableNumber,
        total_amount: total,
        items: cart
    };
    
    try {
        const response = await fetch('/orders/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`Orden ${data.order_number} creada exitosamente!`);
            clearCart();
        }
    } catch (error) {
        alert('Error al crear la orden');
        console.error(error);
    }
}
</script>
{% endblock %}
